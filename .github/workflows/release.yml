name: ðŸŽ‰ Release Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  discussions: write

env:
  MINECRAFT_VERSION: "1.20.4"
  FABRIC_VERSION: "0.15.6"

jobs:
  # Job 1: Crear release
  create-release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      upload-url: ${{ steps.create-release.outputs.upload_url }}
      version: ${{ steps.get-version.outputs.version }}
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ·ï¸ Get version
      id: get-version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: ðŸ“‹ Generate release notes
      id: release-notes
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        
        # Obtener el tag anterior
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        cat > release_notes.md << EOF
        # ðŸš€ BuildFabricModServer ${VERSION}
        
        **Fecha de Release:** $(date -u +"%Y-%m-%d")
        **Commit:** ${{ github.sha }}
        
        ## ðŸŽ® InformaciÃ³n del Servidor
        
        - **Minecraft Version:** ${{ env.MINECRAFT_VERSION }}
        - **Fabric Loader Version:** ${{ env.FABRIC_VERSION }}
        - **Java Version:** 17+
        - **Arquitecturas Soportadas:** x86_64, ARM64
        
        ## ðŸ“¦ QuÃ© Incluye Este Release
        
        ### ðŸ› ï¸ Scripts Principales
        - \`install.sh\` - Instalador automÃ¡tico completo
        - \`update-server.sh\` - Actualizador con backups automÃ¡ticos
        - \`benchmark.sh\` - Suite de benchmarking y pruebas de rendimiento
        - \`iniciador_optimizado_de_minecraft.sh\` - Iniciador con flags JVM optimizados
        - \`script_optimizacion_debian_11_ARM.sh\` - Optimizaciones para sistemas ARM
        - \`script_optimizacion_debian_11_x86-x86_64.sh\` - Optimizaciones para x86/x64
        
        ### ðŸ³ Soporte Docker
        - \`Dockerfile\` - Imagen multi-arquitectura optimizada
        - \`docker-compose.yml\` - OrquestaciÃ³n completa con servicios auxiliares
        - \`docker-run.sh\` - Gestor simplificado de contenedores
        
        ### âš™ï¸ Configuraciones
        - Templates de configuraciÃ³n optimizados
        - Configuraciones especÃ­ficas por arquitectura
        - Configuraciones de seguridad integradas
        
        ### ðŸ“š DocumentaciÃ³n
        - GuÃ­a de inicio rÃ¡pido
        - DocumentaciÃ³n completa de API
        - Wiki con troubleshooting
        - Templates de issues y PRs
        
        EOF
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          echo "## ðŸ“ Cambios desde ${PREVIOUS_TAG}" >> release_notes.md
          echo "" >> release_notes.md
          
          # Obtener commits desde el Ãºltimo tag
          git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --reverse >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        cat >> release_notes.md << EOF
        
        ## ðŸš€ InstalaciÃ³n RÃ¡pida
        
        ### OpciÃ³n 1: InstalaciÃ³n AutomÃ¡tica
        \`\`\`bash
        # Clonar repositorio
        git clone https://github.com/${{ github.repository }}.git
        cd BuildFabricModServer
        
        # Ejecutar instalador
        chmod +x install.sh
        ./install.sh
        \`\`\`
        
        ### OpciÃ³n 2: Docker (Recomendado)
        \`\`\`bash
        # Descargar archivos
        wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/docker-compose.yml
        
        # Configurar y ejecutar
        docker-compose up -d
        \`\`\`
        
        ### OpciÃ³n 3: Imagen Docker Directa
        \`\`\`bash
        docker run -d -p 25565:25565 \\
          -e EULA=true \\
          -v minecraft_world:/opt/minecraft/server/world \\
          ghcr.io/${{ github.repository }}:${VERSION}
        \`\`\`
        
        ## ðŸ”§ ConfiguraciÃ³n BÃ¡sica
        
        1. **Aceptar EULA:** Cambiar \`eula=false\` a \`eula=true\` en \`eula.txt\`
        2. **Optimizar sistema:** Ejecutar script de optimizaciÃ³n correspondiente
        3. **Configurar servidor:** Editar \`server.properties\` segÃºn necesidades
        4. **Agregar mods:** Colocar archivos .jar en carpeta \`mods/\`
        
        ## ðŸ“Š Optimizaciones Incluidas
        
        ### Sistema
        - Configuraciones de kernel optimizadas
        - GestiÃ³n de memoria mejorada
        - Optimizaciones de red especÃ­ficas por arquitectura
        - ConfiguraciÃ³n de firewall y seguridad
        
        ### JVM
        - Flags de Aikar optimizados
        - Garbage Collector G1 configurado
        - DetecciÃ³n automÃ¡tica de RAM
        - Optimizaciones especÃ­ficas por CPU
        
        ### Docker
        - Imagen multi-arquitectura
        - Healthchecks automÃ¡ticos
        - ConfiguraciÃ³n de recursos optimizada
        - Servicios auxiliares (backup, monitoreo)
        
        ## ðŸ†˜ Soporte
        
        - ðŸ“š [DocumentaciÃ³n Completa](https://github.com/${{ github.repository }}/wiki)
        - ðŸš€ [GuÃ­a de Inicio RÃ¡pido](https://github.com/${{ github.repository }}/blob/main/docs/QUICK_START.md)
        - ðŸ› [Reportar Issues](https://github.com/${{ github.repository }}/issues/new/choose)
        - ðŸ’¬ [Discusiones](https://github.com/${{ github.repository }}/discussions)
        
        ## ðŸ¤ Contribuir
        
        Â¡Las contribuciones son bienvenidas! Por favor lee nuestra [guÃ­a de contribuciÃ³n](CONTRIBUTING.md).
        
        ## ðŸ“„ Licencia
        
        Este proyecto estÃ¡ licenciado bajo la Licencia MIT. Ver [LICENSE](LICENSE) para mÃ¡s detalles.
        
        ---
        
        **Checksum de Archivos:**
        Los checksums SHA256 de todos los archivos se encuentran en el archivo \`checksums.txt\` adjunto.
        
        **VerificaciÃ³n de Firma:**
        Este release estÃ¡ firmado digitalmente. Verifica la autenticidad antes de usar en producciÃ³n.
        EOF
        
        echo "Release notes generadas:"
        cat release_notes.md
        
    - name: ðŸŽ‰ Create Release
      id: create-release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get-version.outputs.version }}
        name: "Release ${{ steps.get-version.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease || false }}
        generate_release_notes: false
        discussion_category_name: "Releases"

  # Job 2: Construir y adjuntar assets
  build-assets:
    name: ðŸ“¦ Build Release Assets
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Create release package
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        PACKAGE_NAME="BuildFabricModServer-${VERSION}"
        
        echo "ðŸ“¦ Creando paquete de release: ${PACKAGE_NAME}"
        
        # Crear directorio temporal
        mkdir -p "/tmp/${PACKAGE_NAME}"
        
        # Copiar archivos esenciales
        cp -r \
          *.sh \
          *.yml \
          Dockerfile \
          configs/ \
          docs/ \
          README.md \
          LICENSE \
          .gitignore \
          "/tmp/${PACKAGE_NAME}/"
        
        # Crear archivo de informaciÃ³n de versiÃ³n
        cat > "/tmp/${PACKAGE_NAME}/VERSION" << EOF
        BuildFabricModServer ${VERSION}
        Minecraft: ${{ env.MINECRAFT_VERSION }}
        Fabric: ${{ env.FABRIC_VERSION }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Commit: ${{ github.sha }}
        EOF
        
        # Crear archivo de instalaciÃ³n rÃ¡pida
        cat > "/tmp/${PACKAGE_NAME}/INSTALL_QUICK.md" << EOF
        # InstalaciÃ³n RÃ¡pida - BuildFabricModServer ${VERSION}
        
        ## OpciÃ³n 1: InstalaciÃ³n AutomÃ¡tica
        \`\`\`bash
        chmod +x install.sh
        ./install.sh
        \`\`\`
        
        ## OpciÃ³n 2: Docker
        \`\`\`bash
        # Editar docker-compose.yml (cambiar EULA=true)
        docker-compose up -d
        \`\`\`
        
        ## ConfiguraciÃ³n MÃ­nima
        1. Aceptar EULA: editar eula.txt
        2. Ejecutar script de optimizaciÃ³n
        3. Iniciar servidor
        
        Ver README.md para documentaciÃ³n completa.
        EOF
        
        # Crear checksums
        cd "/tmp/${PACKAGE_NAME}"
        find . -type f -exec sha256sum {} \; > checksums.txt
        cd -
        
        # Crear archivos comprimidos
        cd /tmp
        tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}/"
        zip -r "${PACKAGE_NAME}.zip" "${PACKAGE_NAME}/"
        
        # Mover a directorio de trabajo
        mv "${PACKAGE_NAME}.tar.gz" "${GITHUB_WORKSPACE}/"
        mv "${PACKAGE_NAME}.zip" "${GITHUB_WORKSPACE}/"
        mv "${PACKAGE_NAME}/checksums.txt" "${GITHUB_WORKSPACE}/"
        
        echo "âœ… Paquetes creados:"
        ls -la "${PACKAGE_NAME}".*
        ls -la checksums.txt
        
    - name: ðŸ“¤ Upload release assets
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        PACKAGE_NAME="BuildFabricModServer-${VERSION}"
        
        # Subir archivos comprimidos
        gh release upload "${VERSION}" \
          "${PACKAGE_NAME}.tar.gz" \
          "${PACKAGE_NAME}.zip" \
          "checksums.txt" \
          "docker-compose.yml" \
          --clobber
        
        echo "âœ… Assets subidos al release ${VERSION}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: Actualizar documentaciÃ³n post-release
  update-docs:
    name: ðŸ“š Update Documentation
    runs-on: ubuntu-latest
    needs: [create-release, build-assets]
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“ Update version references
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        
        echo "ðŸ“ Actualizando referencias de versiÃ³n a ${VERSION}..."
        
        # Actualizar README.md con nueva versiÃ³n
        sed -i "s/Version: [0-9]\+\.[0-9]\+\.[0-9]\+/Version: ${VERSION#v}/" README.md
        
        # Actualizar docker-compose.yml con nueva imagen
        sed -i "s|ghcr.io/${{ github.repository }}:.*|ghcr.io/${{ github.repository }}:${VERSION}|" docker-compose.yml
        
        # Crear badge de versiÃ³n actualizado
        cat > .github/version-badge.json << EOF
        {
          "schemaVersion": 1,
          "label": "version",
          "message": "${VERSION#v}",
          "color": "blue"
        }
        EOF
        
        echo "âœ… Referencias de versiÃ³n actualizadas"
        
    - name: ðŸ“¤ Commit documentation updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if ! git diff --quiet; then
          git add .
          git commit -m "docs: update version references to ${{ needs.create-release.outputs.version }} [skip ci]"
          git push
          echo "âœ… DocumentaciÃ³n actualizada y commiteada"
        else
          echo "â„¹ï¸ No hay cambios en la documentaciÃ³n"
        fi

  # Job 4: Notificaciones post-release
  notify-release:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, build-assets, update-docs]
    if: success()
    
    steps:
    - name: ðŸ“¢ Create discussion post
      uses: actions/github-script@v7
      with:
        script: |
          const version = "${{ needs.create-release.outputs.version }}";
          const releaseUrl = `https://github.com/${{ github.repository }}/releases/tag/${version}`;
          
          const discussionBody = `
          # ðŸŽ‰ Nueva VersiÃ³n Disponible: ${version}
          
          Â¡Hemos lanzado una nueva versiÃ³n de BuildFabricModServer!
          
          ## ðŸš€ Highlights de esta versiÃ³n:
          - Minecraft ${{ env.MINECRAFT_VERSION }}
          - Fabric ${{ env.FABRIC_VERSION }}
          - Optimizaciones mejoradas
          - Mejor soporte Docker
          
          ## ðŸ“¥ Descargar:
          [Ver Release Completo](${releaseUrl})
          
          ## ðŸ’¬ Â¿QuÃ© opinas?
          Comparte tu experiencia con esta nueva versiÃ³n, reporta cualquier problema que encuentres, o sugiere mejoras para futuras versiones.
          
          ## ðŸ†˜ Â¿Necesitas ayuda?
          Si tienes problemas con la instalaciÃ³n o configuraciÃ³n, no dudes en preguntar aquÃ­ o [crear un issue](https://github.com/${{ github.repository }}/issues/new/choose).
          `;
          
          // Crear discusiÃ³n en la categorÃ­a "Releases"
          try {
            const discussion = await github.rest.teams.createDiscussionInOrg({
              org: context.repo.owner,
              team_slug: context.repo.repo,
              title: `Release ${version} - Â¡Comparte tu experiencia!`,
              body: discussionBody,
            });
            console.log(`DiscusiÃ³n creada: ${discussion.data.html_url}`);
          } catch (error) {
            console.log('No se pudo crear discusiÃ³n automÃ¡ticamente:', error.message);
          }
        
    - name: ðŸ“± Send notification (if webhook configured)
      if: ${{ secrets.DISCORD_WEBHOOK || secrets.SLACK_WEBHOOK }}
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
        
        MESSAGE="ðŸš€ Nueva versiÃ³n disponible: BuildFabricModServer ${VERSION}
        
        ðŸŽ® Minecraft ${{ env.MINECRAFT_VERSION }}
        ðŸ•¸ï¸ Fabric ${{ env.FABRIC_VERSION }}
        
        ðŸ“¥ Descargar: ${RELEASE_URL}"
        
        # Discord webhook (si estÃ¡ configurado)
        if [[ -n "${{ secrets.DISCORD_WEBHOOK }}" ]]; then
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"${MESSAGE}\"}" \
               "${{ secrets.DISCORD_WEBHOOK }}"
        fi
        
        # Slack webhook (si estÃ¡ configurado)
        if [[ -n "${{ secrets.SLACK_WEBHOOK }}" ]]; then
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"text\": \"${MESSAGE}\"}" \
               "${{ secrets.SLACK_WEBHOOK }}"
        fi
        
        echo "âœ… Notificaciones enviadas"

# ConfiguraciÃ³n de notificaciones
on_failure:
  notify_maintainers: true
  create_issue: true